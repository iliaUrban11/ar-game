<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>ГРАНДАКСИН УНИЧТОЖАЕТ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar-nft.js"></script>
  <style>
    body { margin:0; overflow:hidden; background:#000; }
    #startBtn, #destroyBtn {
      position:fixed; left:50%; transform:translateX(-50%); z-index:9999;
      padding:20px 60px; font-size:2em; border:none; border-radius:60px; cursor:pointer;
      font-weight:bold; color:white;
    }
    #startBtn { top:50%; background:#00b894; }
    #destroyBtn { bottom:30px; background:#c23616; display:none; }
    #destroyBtn.active { background:#e84118; transform:translateX(-50%) scale(1.2); }

    #crosshair {
      position:fixed; top:50%; left:50%; width:60px; height:60px;
      margin:-30px 0 0 -30px; pointer-events:none; z-index:999; display:none;
      border: 4px solid cyan; border-radius:50%; box-shadow:0 0 30px cyan;
    }
    #crosshair::before {
      content:''; position:absolute; top:50%; left:0; right:0; height:4px;
      background:cyan; box-shadow:0 0 20px cyan;
    }
    #crosshair::after {
      content:''; position:absolute; left:50%; top:0; bottom:0; width:4px;
      background:cyan; box-shadow:0 0 20px cyan;
    }

    #progress {
      position:fixed; bottom:140px; left:20px; right:20px; display:flex; gap:15px; z-index:999; display:none;
    }
    .bar { flex:1; height:40px; background:rgba(255,255,255,0.2); border-radius:20px; overflow:hidden; position:relative; }
    .fill { height:100%; width:0%; transition:width 0.4s; }
    .label { position:absolute; top:50%; left:15px; transform:translateY(-50%); color:white; font-weight:bold; }
    #red-fill { background:#ff4757; }
    #green-fill { background:#2ed573; }
    #blue-fill { background:#3742fa; }
  </style>
</head>
<body>

  <button id="startBtn">ЗАПУСК</button>
  <button id="destroyBtn">УНИЧТОЖИТЬ!</button>

  <div id="crosshair"></div>

  <div id="progress">
    <div class="bar"><div class="label">RED</div><div id="red-fill" class="fill"></div></div>
    <div class="bar"><div class="label">GREEN</div><div id="green-fill" class="fill"></div></div>
    <div class="bar"><div class="label">BLUE</div><div id="blue-fill" class="fill"></div></div>
  </div>

  <a-scene embedded arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: false;"
    renderer="antialias: true" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">

    <a-assets timeout="60000">
      <a-asset-item id="red"   src="red.glb"></a-asset-item>
      <a-asset-item id="green" src="green.glb"></a-asset-item>
      <a-asset-item id="blue"  src="blue.glb"></a-asset-item>
    </a-assets>

    <a-entity id="models"></a-entity>
  </a-scene>

  <script>
    const scene = document.querySelector('a-scene');
    const modelsGroup = document.getElementById('models');
    const destroyBtn = document.getElementById('destroyBtn');
    let targets = [];
    let currentTarget = null;

    document.getElementById('startBtn').onclick = () => {
      document.getElementById('startBtn').style.display = 'none';
      destroyBtn.style.display = 'block';
      document.getElementById('crosshair').style.display = 'block';
      document.getElementById('progress').style.display = 'flex';

      if (scene.hasLoaded) startGame();
      else scene.addEventListener('loaded', startGame);
    };

    function startGame() {
      for (let color of ['red', 'green', 'blue']) {
        for (let i = 0; i < 10; i++) spawn(color);
      }
      requestAnimationFrame(tick);
    }

    function spawn(color) {
      const el = document.createElement('a-entity');
      el.setAttribute('gltf-model', `#${color}`);
      el.setAttribute('data-color', color);

      const s = 0.3 + Math.random() * 0.4;
      el.setAttribute('scale', `${s} ${s} ${s}`);

      const dist = 3 + Math.random() * 6;
      const angle = Math.random() * Math.PI * 2;
      const h = 0.5 + Math.random() * 2;
      el.setAttribute('position', {
        x: Math.sin(angle) * dist,
        y: h,
        z: -Math.cos(angle) * dist
      });

      modelsGroup.appendChild(el);
      targets.push(el);
    }

    function tick() {
      if (!scene.camera) return requestAnimationFrame(tick);

      const camPos = scene.camera.position;
      const forward = new THREE.Vector3(0, 0, -1);
      forward.applyQuaternion(scene.camera.quaternion);

      let best = null;
      let bestAngle = 0.2; // ~11 градусов — размер прицела

      targets.forEach(t => {
        if (!t.parentNode) return;
        const pos = t.object3D.position;
        const dir = pos.clone().sub(camPos).normalize();
        const angle = dir.angleTo(forward);

        if (angle < bestAngle && pos.distanceTo(camPos) < 15) {
          bestAngle = angle;
          best = t;
        }
      });

      if (best !== currentTarget) {
        if (currentTarget) {
          currentTarget.removeAttribute('material');
        }
        currentTarget = best;
        if (best) {
          best.setAttribute('material', 'emissive', '#00ff00');
          best.setAttribute('emissiveIntensity', 1);
          destroyBtn.classList.add('active');
          destroyBtn.textContent = "УНИЧТОЖИТЬ!";
        } else {
          destroyBtn.classList.remove('active');
          destroyBtn.textContent = "УНИЧТОЖИТЬ ГРАНДАКСИНОМ";
        }
      }

      requestAnimationFrame(tick);
    }

    destroyBtn.onclick = () => {
      if (!currentTarget) return;

      const color = currentTarget.getAttribute('data-color');
      window[color + 'Score'] = (window[color + 'Score'] || 0) + 1;
      document.getElementById(color + '-fill').style.width = Math.min(window[color + 'Score'] * 10, 100) + '%';

      currentTarget.setAttribute('animation', 'property: scale; to: 0.01 0.01 0.01; dur: 300; easing: easeInBack');
      setTimeout(() => currentTarget.remove(), 350);

      targets = targets.filter(t => t !== currentTarget);
      currentTarget = null;
      destroyBtn.classList.remove('active');
      destroyBtn.textContent = "УНИЧТОЖИТЬ ГРАНДАКСИНОМ";
    };
  </script>
</body>
</html>
