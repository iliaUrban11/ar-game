<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Грандаксин против</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar-nft.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,system-ui,sans-serif;background:linear-gradient(135deg,#027ACA,#00b894);overflow:hidden;height:100vh;color:#fff}
    #startPage{position:fixed;inset:0;z-index:9999;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:30px;background:rgba(255,255,255,.95);color:#027ACA}
    #logo{font-size:3.2em;font-weight:900;margin-bottom:20px}
    #rules{font-size:1.35em;line-height:1.7;margin-bottom:50px}
    #startGameBtn{padding:18px 60px;background:#027ACA;color:#fff;font-size:1.6em;font-weight:700;border:none;border-radius:50px;cursor:pointer}
    #gameUI{position:fixed;z-index:1000;display:none;width:100%;pointer-events:none}
    #timer{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,.95);color:#027ACA;padding:12px 28px;border-radius:30px;font-size:2.2em;font-weight:900}
    #progress{position:fixed;top:90px;left:20px;right:20px;display:flex;gap:12px}
    .bar{flex:1;height:40px;background:rgba(255,255,255,.15);border-radius:20px;overflow:hidden;position:relative}
    .fill{height:100%;width:0%;transition:width .7s ease;border-radius:20px}
    .label{position:absolute;top:50%;left:18px;transform:translateY(-50%);font-size:15px;font-weight:700;color:#fff;text-shadow:1px 1px 3px #000}
    #nerv-fill{background:#00859D}#anx-fill{background:#411D6B}#stress-fill{background:#EB4C24}
    #uiText{position:fixed;bottom:20px;left:0;right:0;background:rgba(255,255,255,.9);color:#027ACA;padding:14px 20px;font-size:1.15em;text-align:center;line-height:1.5}
    #endScreen{position:fixed;inset:0;z-index:9999;display:none;flex-direction:column;justify-content:center;align-items:center;background:rgba(2,122,202,.98);padding:40px;text-align:center}
    #endTitle{font-size:3em;font-weight:900;margin-bottom:30px}
    #endProgress{width:85%;max-width:500px;display:flex;flex-direction:column;gap:18px;margin:30px 0}
    #endResults{font-size:1.7em;line-height:2;margin:20px 0}
    #playAgainBtn{padding:18px 55px;background:#fff;color:#027ACA;font-size:1.5em;font-weight:800;border:none;border-radius:50px;cursor:pointer}
  </style>
</head>
<body>

  <div id="startPage">
    <div id="logo">ГРАНДАКСИН ПРОТИВ23</div>
    <div id="rules">
      Совместите цель с летающим симптомом<br>и нажмите на экран.<br><br>
      Сбейте как можно больше за 30 секунд!
    </div>
    <button id="startGameBtn">НАЧАТЬ</button>
  </div>

  <div id="gameUI">
    <div id="timer">30</div>
    <div id="progress">
      <div class="bar"><div class="label">Нервозность</div><div id="nerv-fill" class="fill"></div></div>
      <div class="bar"><div class="label">Тревога</div><div id="anx-fill" class="fill"></div></div>
      <div class="bar"><div class="label">Стресс</div><div id="stress-fill" class="fill"></div></div>
    </div>
    <div id="uiText">Совместите цель с летающим симптомом<br>и нажмите на экран</div>
  </div>

  <div id="endScreen">
    <div id="endTitle">Спасибо за игру!</div>
    <div id="endProgress">
      <div class="bar"><div class="label">Нервозность</div><div id="end-nerv-fill" class="fill"></div></div>
      <div class="bar"><div class="label">Тревога</div><div id="end-anx-fill" class="fill"></div></div>
      <div class="bar"><div class="label">Стресс</div><div id="end-stress-fill" class="fill"></div></div>
    </div>
    <div id="endResults">
      Вы уничтожили:<br>
      <span id="nerv-result"></span><br>
      <span id="anx-result"></span><br>
      <span id="stress-result"></span>
    </div>
    <button id="playAgainBtn">ИГРАТЬ ЕЩЁ РАЗ</button>
  </div>

  <audio id="hitSound" src="hit.mp3" preload="auto"></audio>

  <a-scene embedded
    arjs="sourceType: webcam;
          detectionMode: mono;
          trackingMethod: best;
          debugUIEnabled: false;
          maxDetectionRate: 30;
          canvasWidth: 640;
          canvasHeight: 480;
          smoothingFactor: 0.95;"
    renderer="antialias: true"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    style="display:none"
    cursor="rayOrigin: mouse"
    raycaster="objects: .clickable">

    <a-assets timeout="60000">
      <a-asset-item id="nerv"   src="red.glb"></a-asset-item>
      <a-asset-item id="anx"    src="green.glb"></a-asset-item>
      <a-asset-item id="stress" src="blue.glb"></a-asset-item>
    </a-assets>

    <a-camera look-controls="enabled: true">
      <a-cursor position="0 0 -1" geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                material="color: white; shader: flat; opacity: 0.6"></a-cursor>
    </a-camera>

    <a-entity id="models"></a-entity>
  </a-scene>

  <script>
    // Глобальные переменные
    let scores = { nerv: 0, anx: 0, stress: 0 };
    let sceneEl, modelsGroup, timer, animationId;
    let timeLeft = 30;
    let active = false;
    const hit = document.getElementById('hitSound');
    let models = [];

    // Позиции моделей
    const positions = [
      {x:-4,y:2.0,z:-6},{x:-2,y:1.5,z:-5},{x:0,y:2.5,z:-7},{x:3,y:1.8,z:-6},{x:5,y:2.2,z:-8},
      {x:-3,y:3.0,z:-7},{x:2,y:0.8,z:-5},{x:-1,y:3.5,z:-9},{x:4,y:2.8,z:-7},{x:1,y:1.2,z:-8},
      {x:-5,y:1.0,z:-7},{x:-3,y:2.8,z:-5},{x:1,y:3.2,z:-6},{x:4,y:1.5,z:-9},{x:-1,y:2.0,z:-8},
      {x:6,y:2.5,z:-6},{x:-4,y:0.9,z:-5},{x:2,y:3.8,z:-8},{x:-2,y:1.8,z:-9},{x:3,y:2.4,z:-5},
      {x:0,y:1.0,z:-6},{x:-6,y:2.0,z:-8},{x:5,y:3.0,z:-7},{x:-2,y:2.6,z:-6},{x:3,y:0.7,z:-7},
      {x:-5,y:3.3,z:-6},{x:4,y:1.3,z:-8},{x:-1,y:2.9,z:-5},{x:2,y:1.6,z:-9},{x:1,y:3.5,z:-7}
    ];

    // Начало игры
    document.getElementById('startGameBtn').onclick = function() {
      document.getElementById('startPage').style.display = 'none';
      document.getElementById('gameUI').style.display = 'block';
      sceneEl = document.querySelector('a-scene');
      modelsGroup = document.getElementById('models');
      sceneEl.style.display = 'block';

      scores = { nerv: 0, anx: 0, stress: 0 };
      timeLeft = 30;
      active = true;
      models = [];
      updateBars();

      if (sceneEl.hasLoaded) {
        start();
      } else {
        sceneEl.addEventListener('loaded', start);
      }

      timer = setInterval(function() {
        timeLeft--;
        document.getElementById('timer').textContent = timeLeft;
        if (timeLeft <= 0) finish();
      }, 1000);
    };

    // Перезапуск игры
    document.getElementById('playAgainBtn').onclick = function() {
      location.reload();
    };

    function finish() {
      active = false;
      clearInterval(timer);
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
      modelsGroup.innerHTML = '';

      setTimeout(function() {
        document.getElementById('nerv-result').innerHTML = 'Нервозность: <b>' + scores.nerv + '</b>';
        document.getElementById('anx-result').innerHTML = 'Тревога: <b>' + scores.anx + '</b>';
        document.getElementById('stress-result').innerHTML = 'Стресс: <b>' + scores.stress + '</b>';

        setTimeout(function() {
          document.getElementById('end-nerv-fill').style.width = Math.min(scores.nerv * 10, 100) + '%';
          document.getElementById('end-anx-fill').style.width = Math.min(scores.anx * 10, 100) + '%';
          document.getElementById('end-stress-fill').style.width = Math.min(scores.stress * 10, 100) + '%';
        }, 300);

        document.getElementById('gameUI').style.display = 'none';
        document.getElementById('endScreen').style.display = 'flex';
      }, 800);
    }

    function start() {
      modelsGroup.innerHTML = '';
      
      positions.forEach(function(p, i) {
        const type = ['nerv','anx','stress'][Math.floor(i/10)];
        const el = document.createElement('a-entity');
        el.setAttribute('gltf-model', '#' + type);
        el.setAttribute('data-color', type);
        el.classList.add('clickable');
        el.setAttribute('scale', '0.35 0.35 0.35');
        el.setAttribute('position', p.x + ' ' + p.y + ' ' + p.z);
        
        // Простая инициализация без сложной логики
        el.addEventListener('model-loaded', function() {
          const obj = el.object3D;
          obj.traverse(function(n) { 
            if (n.isMesh) {
              n.frustumCulled = false;
            }
          });
        });

        el.addEventListener('click', function() {
          if (!active) return;
          scores[type]++;
          updateBars();
          if (hit) {
            hit.currentTime = 0;
            hit.play();
          }
          el.setAttribute('animation', {property:'scale', to:'0.01 0.01 0.01', dur:300, easing:'easeInBack'});
          setTimeout(function() {
            el.parentNode.removeChild(el);
          }, 350);
        });

        modelsGroup.appendChild(el);
        models.push(el);
      });
      
      // Упрощенная анимация поворота
      rotateModels();
    }

    function rotateModels() {
      if (!active || !sceneEl || !sceneEl.camera) {
        animationId = requestAnimationFrame(rotateModels);
        return;
      }
      
      const cameraPos = sceneEl.camera.el.object3D.position;
      
      // Обходим только видимые модели
      for (let i = 0; i < models.length; i++) {
        const model = models[i];
        if (model.object3D && model.object3D.visible) {
          // Простой и стабильный поворот
          model.object3D.lookAt(cameraPos);
        }
      }
      
      animationId = requestAnimationFrame(rotateModels);
    }

    function updateBars() {
      document.getElementById('nerv-fill').style.width = Math.min(scores.nerv * 10, 100) + '%';
      document.getElementById('anx-fill').style.width = Math.min(scores.anx * 10, 100) + '%';
      document.getElementById('stress-fill').style.width = Math.min(scores.stress * 10, 100) + '%';
    }
  </script>
</body>
</html>
